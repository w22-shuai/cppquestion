---
export const prerender = false;

const runtime = Astro.locals.runtime;
const env = runtime?.env;

// 防止本地开发报错
if (!env || !env.checkidentity) {
	throw new Error("请确保 wrangler.toml 绑定了 checkidentity KV");
}

const timenow = Math.floor(Date.now() / 1000);

// 1. 获取上次更新 Token 的时间
// 注意：从 KV 取出来的是字符串，要转数字
let timelast = await env.checkidentity.get("time");
timelast = timelast ? parseInt(timelast) : 0;

// 2. 检查是否超过 24小时 (86400秒) 或 从未设置过
if ((timenow - timelast) > 1) {
	// 生成新的随机 Token
	const newToken = crypto.randomUUID();

	// 更新时间
	await env.checkidentity.put('time', timenow.toString());
	// 更新 KV 里的 Token (注意：这里存的是 newToken，不是 timenow)
	await env.checkidentity.put('cookie', newToken);

	console.log("Token 已过期，已刷新为新 Token");
}

// 3. 处理表单提交 (POST)
if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const key = formData.get("key");
	const value = formData.get("value");

	// 硬编码校验账号密码
	if (key === "ybysb" && value === "e5f04750905af0abed99b3b119474ce4") {
		// 从 KV 获取当前有效的 Token
		// 修正：这里用 env.checkidentity，不要用 env.KV
		const validToken = await env.checkidentity.get('cookie');

		// 设置 Cookie
		const ttl = 86400;
		Astro.cookies.set("auth_token", validToken, {
			path: "/",
			maxAge: ttl,
			httpOnly: true,
			secure: true
		});

		// 验证成功，跳转到问题页
		return Astro.redirect("/cppquestion");
	} else {
		// 密码错误，可以在这里处理，或者直接让它继续渲染下面的 HTML
		console.error("密码错误");
	}
}

// 4. 处理 GET 请求
// 不需要写 if (GET) redirect，
// 代码执行到这里如果没有 return，就会自动渲染下面的 HTML，这样用户就能看到表单了。
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Login</title>
</head>
<body style="padding: 50px; display: flex; flex-direction: column; align-items: center;">

<h3>系统登录</h3>

<form method="POST" style="display: flex; flex-direction: column; gap: 10px; width: 300px;">
	<input type="text" name="key" placeholder="Key" required>
	<input type="password" name="value" placeholder="Value" required>
	<button type="submit">提交</button>
</form>

</body>
</html>