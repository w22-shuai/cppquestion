---
export const prerender = false;

const runtime = Astro.locals.runtime;
const env = runtime?.env;


const PRIVATE_KEY_PEM =`-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC017jit3pwl9Bq
neBmTvf4n6GU/S1kRN0EvN2jAqB5xDjiCd3q6xmwDKo4vKHr/u+FL+zNeu0PReBZ
ai3fOdGPzva7/93XOl2fCP4VVuTd5pMNx7G/iz0s/03EIZCV4gOfo8/KKucRgHYj
EaSsgoBulDel7Xw9tAA7/V/3/pqX1l+0Ldkrd561A3qdCD1JUPVACQ7HffTgOo3i
IliMHMC6FxNVXEkbw/Zyv1By/Ww9Y2xLz2az9n6CotmbWNchsvwzPZNyFpkeztvE
rUaniZe60tK/5sUmcqw+RqZ3TZ5aLFc/k5kgqBOHq/R7AGdpuyjKbBHY0XYh3l4e
NdR/b/5zAgMBAAECggEAFc/JCGtJ1MeyxxE4rg5LQUz7n60zqtrVb4taDh20fktI
8xZukjV9+Spl44b43q52dDF2FciETCnI5+/zDW/7UyWKw90WBC4ReauLfcZnv03e
obRav3gLTmCSoBvORQ2oEzqeRsuK6CT+2rb3jikFVZEB7zzoFccemh2y1AX83mA0
bTO+4eeqZKy470ZWrUJ0nEK4mEAmWc9KrO46myM9FWU3jRjtGF4VKs8ZM5DLT6ht
kAA8p9e0BhL61aF5e0ksNIjkvj/myZU6/acqTjDJH93P5tdpb0eNMxRHAklrV9zz
N0xNfeFe06E1F1qg5fll31QoXF950XXrNhi3kun5KQKBgQDaTXat3TofXNmoN6Fa
QkVskvulCTtGIv9Ay6v9Pbcqr1lQxxjOnw7Z9N1Ynu5zW/DPR+cIJtGNIWhK0igO
EgLwarBe9LQ4ZWsXXV/l0KX5sje4TAKBs67IqVmzVh+/1w3XaeywuqkyaLlwZSxs
yHpGmAReFBnKhfNkm00LzDhUyQKBgQDUEkMHLGktZS3VkfDa+eyXupAldPpT3Rhv
+iSxUC7gwOf+barNPdsApIswFB6N3FKoJHJQp6hGYrwPADzgzvVBqwMEv010cri3
A/OF4NALrG+EuXKstvzwTjGnsvhIBMT67ZXIN2VPwOlkWCo3Zmnfsh7oO9c5k+1I
4/VHmk+DWwKBgQC1GU47LivpmL14L65Lkm7Fg6n/X4ksxhu7RTuI+onZf145BPIv
dwR7DAgUXMS0LrG3Q48F1C5DRlOevnk8MvT9PYTTQW3A22HcIDpODKmkW5Sd73Ck
6Ms27Ebd37S3EVEKQ3V3p2J1zysHcudH14iYx8PXyBUdTcJ809k20FRrAQKBgGw4
tYPfofzMeUtXonXcvGPhjNXQkD5jwajDGh5yMLn5N2qbRGJggnYdgfoTClSSbovn
rX6DUFg64oU1NdvzQS01u+CcT0ZxlNmwZoGXbBPI90/f4ylIaGOpQ6W0qwb1iCAV
Ri5aNpUweOoAI+sJlFXXa/ZPM1Hqr1hXHEBh+tmpAoGBALMhHjPeIdUk1I65BUZD
PGcxTMAP+2LOZREqqzM8bjAzuxjdOXsrTexVyxzaFys7koEjxqKgruqRq1MjqWNY
nAOvepvE87pgqVwHLxhF5X6sFtE+kATsAXI4+xqm+HW1netjUiL/lWBMAMPyCQzf
NafUvvaJZkT2HH6q9VGaGl5x
-----END PRIVATE KEY-----
`
async function decryptData(encryptedBase64) {
	try {
		// 1. 处理 PEM 格式
		const pemContents = PRIVATE_KEY_PEM
			.replace(/-----[^-]+-----/g, "")
			.replace(/\s+/g, "");

		// 2. Base64 转 ArrayBuffer
		const binaryDerString = atob(pemContents);
		const binaryDer = new Uint8Array(binaryDerString.length);
		for (let i = 0; i < binaryDerString.length; i++) {
			binaryDer[i] = binaryDerString.charCodeAt(i);
		}

		// 3. 导入私钥
		const privateKey = await crypto.subtle.importKey(
			"pkcs8",
			binaryDer.buffer,
			{ name: "RSA-OAEP", hash: "SHA-256" },
			false,
			["decrypt"]
		);

		// 4. 解密
		const encryptedData = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
		const decryptedBuffer = await crypto.subtle.decrypt(
			{ name: "RSA-OAEP" },
			privateKey,
			encryptedData
		);

		// 5. ArrayBuffer 转字符串
		return new TextDecoder().decode(decryptedBuffer);
	} catch (e) {
		console.error("解密失败:", e);
		return null;
	}
}


if (!env || !env.checkidentity) {
	// throw new Error("请确保 wrangler.toml 绑定了 checkidentity KV");
	// 为了不让页面挂掉，本地开发时这里不抛错，只是不能登录
} else {
	const timenow = Math.floor(Date.now() / 1000);
	let timelast = await env.checkidentity.get("time");
	timelast = timelast ? parseInt(timelast) : 0;

	if ((timenow - timelast) > 86400) {
		const newToken = crypto.randomUUID();
		await env.checkidentity.put('time', timenow.toString());
		await env.checkidentity.put('cookie', newToken);
		return Astro.redirect("/login");
	}
}

let errorMsg = "";

// =================================================================
// 3. 处理表单提交 (POST)
// =================================================================
try{if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const key = formData.get("key"); // 用户名 (明文)
	const encryptedValue = formData.get("encrypted_value"); // 密码 (RSA加密过的)

	// 1. 解密密码
	let decryptedValue = null;
	if (encryptedValue) {
		decryptedValue = await decryptData(encryptedValue.toString());
	}

	// 2. 校验账号密码
	// 用户名: ybysb
	// 密码: e5f04750905af0abed99b3b119474ce4
	if (key === "ybysb" && decryptedValue === "e5f04750905af0abed99b3b119474ce4") {

		if (env?.checkidentity) {
			const validToken = await env.checkidentity.get('cookie');
			// 设置 Cookie
			Astro.cookies.set("auth_token", validToken, {
				path: "/",
				maxAge: 86400,
				httpOnly: true,
				secure: true
			});
			return Astro.redirect("/cppquestion");
		} else {
			errorMsg = "环境错误：无法连接鉴权数据库";
		}
	} else {
		errorMsg = "⚠️ 验证失败：账号或密码错误";
		// 如果解密失败，decryptedValue 为 null，也会走这里
	}
}}
catch (e) {
	return Astro.redirect("/login");
}

---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SYSTEM LOGIN</title>
	<style>
		/* ==================== 全局背景 (Cyberpunk 风格) ==================== */
		body {
			font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
			margin: 0;
			padding: 0;
			color: #fff;
			height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: #000;
			overflow: hidden;

			/* 背景图 */
			background-image: url('https://images.unsplash.com/photo-1518546305927-5a555bb7020d?q=80&w=2069&auto=format&fit=crop');
			background-size: cover;
			background-position: center;
		}

		/* 黑色蒙版 */
		body::before {
			content: '';
			position: absolute;
			top: 0; left: 0; right: 0; bottom: 0;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(5px);
			z-index: 1;
		}

		/* ==================== 登录框容器 ==================== */
		.login-box {
			position: relative;
			z-index: 10;
			width: 100%;
			max-width: 400px;
			padding: 40px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 12px;
			box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(15px);
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		/* 装饰性边框 */
		.login-box::after {
			content: '';
			position: absolute;
			top: -2px; left: -2px; right: -2px; bottom: -2px;
			background: linear-gradient(45deg, #00f2ff, transparent, #0aff60, transparent);
			z-index: -1;
			border-radius: 14px;
			animation: border-rotate 4s linear infinite;
			opacity: 0.3;
		}

		h2 {
			margin: 0 0 30px 0;
			font-weight: 300;
			letter-spacing: 4px;
			color: #fff;
			text-transform: uppercase;
			text-shadow: 0 0 10px rgba(255,255,255,0.5);
		}

		/* ==================== 表单元素 ==================== */
		form {
			width: 100%;
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.input-group {
			position: relative;
		}

		input {
			width: 100%;
			padding: 15px;
			box-sizing: border-box;
			background: rgba(0, 0, 0, 0.4);
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 6px;
			color: #fff;
			font-size: 16px;
			outline: none;
			transition: all 0.3s;
			letter-spacing: 1px;
		}

		input:focus {
			border-color: #00f2ff;
			background: rgba(0, 0, 0, 0.6);
			box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
		}

		input::placeholder {
			color: rgba(255, 255, 255, 0.3);
			text-transform: uppercase;
			font-size: 12px;
		}

		button {
			padding: 15px;
			background: rgba(0, 242, 255, 0.1);
			color: #00f2ff;
			border: 1px solid #00f2ff;
			border-radius: 6px;
			font-size: 16px;
			font-weight: bold;
			text-transform: uppercase;
			letter-spacing: 2px;
			cursor: pointer;
			transition: all 0.3s;
			margin-top: 10px;
			position: relative;
			overflow: hidden;
		}

		button:hover {
			background: #00f2ff;
			color: #000;
			box-shadow: 0 0 30px rgba(0, 242, 255, 0.6);
		}

		.error-msg {
			color: #ff4d4d;
			font-size: 14px;
			margin-bottom: 20px;
			text-align: center;
			background: rgba(255, 0, 0, 0.1);
			padding: 10px;
			border-radius: 4px;
			border: 1px solid rgba(255, 0, 0, 0.3);
			width: 100%;
			box-sizing: border-box;
		}

		/* 加载动画 */
		.loader {
			display: none;
			width: 20px;
			height: 20px;
			border: 3px solid rgba(255,255,255,0.3);
			border-radius: 50%;
			border-top-color: #fff;
			animation: spin 1s ease-in-out infinite;
			position: absolute;
			left: 50%; top: 50%;
			margin-left: -13px; margin-top: -13px;
		}

		button.loading {
			color: transparent;
		}
		button.loading .loader {
			display: block;
		}

		@keyframes spin { to { transform: rotate(360deg); } }
		@keyframes border-rotate {
			0% { filter: hue-rotate(0deg); }
			100% { filter: hue-rotate(360deg); }
		}

	</style>
</head>
<body>

<div class="login-box">
	<h2>Access Control</h2>

	{errorMsg && <div class="error-msg">{errorMsg}</div>}

	<form id="loginForm" method="POST">
		<div class="input-group">
			<input type="text" name="key" placeholder="Identity Key" required autocomplete="off">
		</div>

		<div class="input-group">
			<input type="password" id="raw_password" placeholder="Passcode" required>
			<!-- 这是一个隐藏的输入框，用于存放加密后的密码，发送给服务器 -->
			<input type="hidden" name="encrypted_value" id="encrypted_value">
		</div>

		<button type="submit" id="submitBtn">
			Initialize
			<div class="loader"></div>
		</button>
	</form>
</div>

<!--
    =================================================================
    RSA 公钥 (前端加密用)
    =================================================================
-->
<script is:inline>
	alert("请登录!")
	const PUBLIC_KEY_PEM = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtNe44rd6cJfQap3gZk73
+J+hlP0tZETdBLzdowKgecQ44gnd6usZsAyqOLyh6/7vhS/szXrtD0XgWWot3znR
j872u//d1zpdnwj+FVbk3eaTDcexv4s9LP9NxCGQleIDn6PPyirnEYB2IxGkrIKA
bpQ3pe18PbQAO/1f9/6al9ZftC3ZK3eetQN6nQg9SVD1QAkOx3304DqN4iJYjBzA
uhcTVVxJG8P2cr9Qcv1sPWNsS89ms/Z+gqLZm1jXIbL8Mz2TchaZHs7bxK1Gp4mX
utLSv+bFJnKsPkamd02eWixXP5OZIKgTh6v0ewBnabsoymwR2NF2Id5eHjXUf2/+
cwIDAQAB
-----END PUBLIC KEY-----
`;
	async function encryptData(data) {
		try {
			// 1. 处理 PEM
			const pemContents = PUBLIC_KEY_PEM
				.replace(/-----[^-]+-----/g, "")
				.replace(/\s+/g, "");

			// 2. Base64 转 ArrayBuffer
			const binaryDerString = atob(pemContents);
			const binaryDer = new Uint8Array(binaryDerString.length);
			for (let i = 0; i < binaryDerString.length; i++) {
				binaryDer[i] = binaryDerString.charCodeAt(i);
			}

			// 3. 导入公钥
			const key = await window.crypto.subtle.importKey(
				"spki",
				binaryDer.buffer,
				{ name: "RSA-OAEP", hash: "SHA-256" },
				false,
				["encrypt"]
			);

			// 4. 加密
			const encoder = new TextEncoder();
			const encodedData = encoder.encode(data);
			const encryptedBuffer = await window.crypto.subtle.encrypt(
				{ name: "RSA-OAEP" },
				key,
				encodedData
			);

			// 5. 转 Base64
			let binary = '';
			const bytes = new Uint8Array(encryptedBuffer);
			const len = bytes.byteLength;
			for (let i = 0; i < len; i++) {
				binary += String.fromCharCode(bytes[i]);
			}
			return btoa(binary);

		} catch (e) {
			console.error("加密失败:", e);
			alert("加密模块初始化失败，请使用现代浏览器");
			return null;
		}
	}
	const form = document.getElementById('loginForm');
	const rawPassInput = document.getElementById('raw_password');
	const encryptedInput = document.getElementById('encrypted_value');
	const btn = document.getElementById('submitBtn');
	if (form) {
		form.addEventListener('submit', async (e) => {
			e.preventDefault(); // 阻止默认提交

			const password = rawPassInput.value;
			if (!password) return;

			btn.classList.add('loading'); // 显示加载动画
			btn.disabled = true;

			// 执行加密
			const encrypted = await encryptData(password);

			if (encrypted) {
				// 将加密后的乱码放入隐藏的 input
				encryptedInput.value = encrypted;
				// 清空原始密码框 (防止明文传输)
				rawPassInput.value = ""; // 可选：实际上提交后页面就刷新了，不清也没事，但为了安全

				// 此时再真正提交表单
				form.submit();
			} else {
				btn.classList.remove('loading');
				btn.disabled = false;
			}
		});
	}
</script>

</body>
</html>